#!/usr/bin/env python

import sys,getopt,os,traceback
import tempfile

def usage():
    print """Usage:
    pyscript file.py
    """

#---------------------------------------------------------------------
# Handle options
#---------------------------------------------------------------------

try:
    opts, args = getopt.getopt(sys.argv[1:], "ho:l:d", ["help","output=",
                                                       "logfile="])
except getopt.GetoptError:
    # print help information and exit:
    usage()
    sys.exit(2)

logFile = "pyscript.log"

DEBUG=False
globals={}
for o, a in opts:
    if o in ("-h", "--help"):
        usage()
        sys.exit()
    if o in ("-o","--output"):
        globals['output']=a
    elif o in ("-l","--logfile"):
        logFile=a
    elif o in ("-d",):
        DEBUG=True
        
if len(args) != 1:
    usage()
    sys.exit(s)

#---------------------------------------------------------------------
# Set up log file
#---------------------------------------------------------------------

# redirect stdout and stderr to file
# keep a copy
save_err = sys.stderr

# open the log file
#tempfile.template="pyscript-"
#logFile = tempfile.mktemp(".log")

if logFile=="-":
    log=sys.stdout
else:
    log = open(logFile,"w")
    print "Log file is",logFile

sys.stderr = log

#---------------------------------------------------------------------
# look for ~/.pyscript
#---------------------------------------------------------------------

# now see about importing the defaults from .pyscript/defaults.py
HOME = os.path.expandvars("$HOME")

# if $HOME/.pyscript directory exists, append this to the python path
# this is so that user defined libs can be imported
if os.path.isdir(HOME+'/.pyscript'):
    sys.path.append(HOME+'/.pyscript')

if os.path.isfile(HOME+'/.pyscript/defaults.py'):
    # try $HOME/.pyscript/defaults.py
    execfile(HOME+'/.pyscript/defaults.py',globals)
else:
    print "No user defaults file found."

print "Executing script..."

#---------------------------------------------------------------------
# now run the script
#---------------------------------------------------------------------
try:
    execfile(args[0],globals)
except:
    divider="-"*60+'\n'

    sys.stderr.write("Exception in user code:\n")
    sys.stderr.write(divider)
    traceback.print_exc(file=sys.stderr)
    sys.stderr.write(divider)

    sys.stdout.write("Exception in user code:\n")
    sys.stdout.write(divider)
    traceback.print_exc(file=sys.stdout)
    sys.stdout.write(divider)
    print "Further clues may be found in the log file:",logFile
else:
    # clean up a bit
    sys.stderr = save_err
    if logFile!="-":
        log.close()
        if not DEBUG:
            print "Removing log file"
            os.remove(logFile)
            print "Removing temp files"
            os.remove("temp.aux")
            os.remove("temp.dvi")
            os.remove("temp.log")
            os.remove("temp.ps")
            os.remove("temp.tex")
            os.remove("temp1.aux")
            os.remove("temp1.dvi")
            os.remove("temp1.eps")
            os.remove("temp1.log")
            os.remove("temp1.tex")
    print "Done!"
    
    


